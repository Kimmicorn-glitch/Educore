/**
 * @fileoverview Firestore Security Rules for EduCore Platform
 *
 * Core Philosophy:
 * This ruleset enforces a strict user-ownership model, augmented by denormalization, to prevent unauthorized data access.
 * All user-specific data is nested under /users/{userId}, ensuring that only the authenticated user can read or write their own data.
 *
 * Data Structure:
 * - /users/{userId}: Stores user account information.  The 'userId' parameter in the path MUST match the 'id' field in the document.
 * - /users/{userId}/supportTickets/{ticketId}: Stores support tickets submitted by users. Each ticket includes a denormalized 'userId' field.
 *
 * Key Security Decisions:
 * - Users can only access their own data under /users/{userId} and its subcollections.
 * - Listing all users is disallowed.
 * - All write operations are validated against the authenticated user's ID.
 *
 * Denormalization for Authorization:
 * - Support tickets include a 'userId' field, which MUST match the parent path's 'userId' parameter. This enables direct authorization checks without additional reads.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Secures the user account document. Only the authenticated user can read or write their own account data.
     * @path /users/{userId}
     * @allow (create) - Authenticated user with UID 'user_abc' creates a new user document where request.resource.data.id == 'user_abc'.
     * @allow (get, update, delete) - Authenticated user with UID 'user_abc' reads, updates, or deletes their own user document.
     * @deny (create) - Authenticated user with UID 'user_abc' attempts to create a user document with a different ID.
     * @deny (get, update, delete) - Authenticated user with UID 'user_xyz' attempts to access user document 'user_abc'.
     * @principle Enforces document ownership; validates relational integrity.
     */
    match /users/{userId} {
      //Function to check if the user is signed in
      function isSignedIn() {
        return request.auth != null;
      }

      //Function to check if the user is the owner
      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      //Function to check if the user is an existing owner
      function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }

      allow get: if isOwner(userId);
      allow list: if false; // Do not allow listing of all users

      allow create: if isSignedIn() && isNewOwner(userId);
      allow update: if isExistingOwner(userId) && isUnchangedOwner(userId);
      allow delete: if isExistingOwner(userId);

      // Helper function to check if the user id matches the document id and the user is signed in
      function isNewOwner(userId) {
          return isSignedIn()
          && request.resource.data.id == userId;
      }

      // Helper function to check if the user id in the existing document matches the user id in the path
      function isUnchangedOwner(userId) {
          return request.resource.data.id == resource.data.id;
      }
    }

    /**
     * @description Secures support tickets under a user's account. Only the user who owns the account can create, read, update, or delete their own support tickets.
     * @path /users/{userId}/supportTickets/{ticketId}
     * @allow (create) - Authenticated user with UID 'user_abc' creates a new support ticket under /users/user_abc/supportTickets/.
     * @allow (get, list, update, delete) - Authenticated user with UID 'user_abc' reads, lists, updates, or deletes their own support tickets under /users/user_abc/supportTickets/.
     * @deny (create) - Authenticated user with UID 'user_xyz' attempts to create a support ticket under /users/user_abc/supportTickets/.
     * @deny (get, list, update, delete) - Authenticated user with UID 'user_xyz' attempts to access support tickets under /users/user_abc/supportTickets/.
     * @principle Enforces document ownership; leverages denormalization for authorization.
     */
    match /users/{userId}/supportTickets/{ticketId} {
      //Function to check if the user is signed in
      function isSignedIn() {
        return request.auth != null;
      }

      //Function to check if the user is the owner
      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      //Function to check if the user is an existing owner
      function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }

      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isSignedIn() && isNewTicket(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);

      //Helper function to check if the support ticket has the correct user id and the user is signed in
      function isNewTicket(userId) {
        return isSignedIn()
        && request.resource.data.userId == userId;
      }
    }
  }
}